
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Logística Interativo</title>
  <style>
    :root {
      --bg: #101010;
      --bg-elev: #171717;
      --surface: #111111;
      --border: #2b2b2b;
      --text: #e6e6e6;
      --muted: #9aa0a6;
      --primary: #2e7fb4;
      --primary-600: #1f5f88;
      --success: #2d8542;
      --danger: #b13a2e;
      --danger-700: #7d2a22;
      --shadow: rgba(0,0,0,0.4);
    }
    /* Tema Grunge/Pro dark */
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(1000px 400px at 10% -10%, rgba(255,255,255,0.04), transparent),
                  radial-gradient(800px 300px at 110% 0%, rgba(255,255,255,0.03), transparent),
                  linear-gradient(180deg, #1a1a1a, var(--bg) 60%);
      margin: 20px;
      padding: 0;
      color: var(--text);
      letter-spacing: 0.3px;
    }
    .container { max-width: 1140px; margin: 0 auto; }

    h2 {
      color: #f1f1f1;
      margin-top: 20px;
      border-bottom: 2px dashed #3a3a3a;
      padding-bottom: 6px;
      text-transform: uppercase;
    }

    form, .card, table {
      background-color: var(--bg-elev);
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 6px 18px var(--shadow);
    }

    label {
      display: inline-block;
      margin: 8px 10px 8px 0;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 220px;
      padding: 8px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      box-sizing: border-box;
      background: #0f0f0f;
      color: #f2f2f2;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    input::placeholder { color: #74797e; }
    input:focus-visible, select:focus-visible { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(46,127,180,0.25); }

    button {
      margin-top: 10px;
      padding: 9px 16px;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: #f7f7f7;
      border: 1px solid #214a64;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.05s ease, filter 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    button:hover { filter: brightness(1.06); }
    button:active { transform: translateY(1px); }
    .secondary { background: linear-gradient(180deg, #6b6f73, #4b4f53) !important; border-color: #3a3e42 !important; color: #f1f1f1 !important; }
    button.danger { background: linear-gradient(180deg, var(--danger), var(--danger-700)); border-color: #5a1e19; }

    table { border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid var(--border); text-align: left; }
    th { background: #0f0f0f; color: #dcdcdc; text-transform: uppercase; font-size: 12px; letter-spacing: 0.8px; }
    tbody tr:nth-child(odd) { background: #141414; }
    tbody tr:hover { background: #191919; }
    thead th:last-child, tbody td:last-child { text-align: center; }

    hr {
      margin: 30px 0;
      border: none;
      border-top: 2px dashed #3a3a3a;
    }

    .cards { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 10px; margin: 10px 0 20px; }
    .card { background: #111; border-color: #2b2b2b; }
    .card .value { font-size: 22px; font-weight: bold; color: #eaeaea; }
    .card .label { color: #9aa0a6; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; }

    .toolbar { display: flex; gap: 8px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
    .toolbar input { width: 260px; }

    .toast {
      position: fixed; right: 20px; bottom: 20px; padding: 12px 16px; border-radius: 6px;
      color: #fff; background: var(--success); box-shadow: 0 4px 10px var(--shadow);
      opacity: 0; transform: translateY(20px); transition: all 0.25s; pointer-events: none;
      border: 1px solid #1e4f29;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: var(--danger-700); border-color: #5a1e19; }

    .progress {
      width: 240px; height: 10px; background: #0f0f0f; border-radius: 10px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 6px; border: 1px solid var(--border);
    }
    .progress > span { display: block; height: 100%; width: 0%; transition: width 0.25s; }
    .progress > span.ok { background: linear-gradient(90deg, #2ecc71, #27ae60); }
    .progress > span.warn { background: linear-gradient(90deg, #f39c12, #d35400); }
    .progress > span.danger { background: linear-gradient(90deg, #e74c3c, #c0392b); }

    .subtabs { display: flex; gap: 8px; margin: 8px 0 12px; border-bottom: 1px dashed #3a3a3a; padding-bottom: 6px; }
    .subtabs button { background: #0f0f0f; border: 1px solid var(--border); color: #dcdcdc; }
    .subtabs button.active { background: #1a1a1a; border-color: #3a3a3a; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03); }
    .subtab-content { display: none; }
    .subtab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
  <div class="cards">
    <div class="card"><div class="value" id="kpiProdutos">0</div><div class="label">Produtos</div></div>
    <div class="card"><div class="value" id="kpiPosicoes">0</div><div class="label">Posições</div></div>
    <div class="card"><div class="value" id="kpiAlocacoes">0</div><div class="label">Alocações</div></div>
  </div>
  <h2>Cadastro de Produtos</h2>
  <form id="produtoForm">
    <label>SKU: <input type="text" id="sku" maxlength="5" pattern="[A-Za-z0-9]{5}" title="5 caracteres alfanuméricos" style="text-transform: uppercase;" required></label><br>
    <label>Descrição (DESC): <input type="text" id="descricao" maxlength="50" style="text-transform: uppercase;" required></label><br>
    <label>Unidade de Medida:
      <select id="unidade">
        <option value="UN">UN</option>
        <option value="CX">CX</option>
        <option value="KG">KG</option>
        <option value="G">G</option>
        <option value="MG">MG</option>
        <option value="T">T</option>
        <option value="L">L</option>
        <option value="ML">ML</option>
        <option value="M">M</option>
        <option value="M2">M2</option>
        <option value="M3">M3</option>
        <option value="PC">PC</option>
        <option value="PCT">PCT</option>
        <option value="DZ">DZ</option>
        <option value="PAL">PAL</option>
      </select>
    </label><br>
    <label>Peso Padrão (kg): <input type="number" id="peso" step="0.01" min="0" required></label><br>
    <label>Volume Padrão (m³): <input type="number" id="volume" step="0.0001" min="0" required></label><br>
    <button type="submit">Cadastrar Produto</button>
  </form>

  <div class="toolbar">
    <input type="text" id="filtroProdutos" placeholder="Filtrar por SKU/Descrição...">
    <button class="secondary" onclick="exportarProdutosCSV()">Exportar CSV</button>
  </div>
  <table id="tabelaProdutos">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Descrição</th>
        <th>Unidade</th>
        <th>Peso (kg)</th>
        <th>Volume (m³)</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr>

  <h2>Cadastro de Posições</h2>
  <div class="toolbar">
    <input type="text" id="filtroPosicoes" placeholder="Filtrar por endereço...">
  </div>
  <form id="posicaoForm">
    <label>Armazém: <input type="text" id="armazem" maxlength="3" pattern="[A-Za-z][0-9]{2}" title="Ex.: A12 (1 letra + 2 dígitos)" style="text-transform: uppercase;" required></label>
    <label>Rua: <input type="text" id="rua" maxlength="2" pattern="\d{2}" title="2 dígitos" required></label>
    <label>Nível: <input type="text" id="nivel" maxlength="2" pattern="\d{2}" title="2 dígitos" required></label>
    <label>Prateleira: <input type="text" id="prateleira" maxlength="3" pattern="\d{3}" title="3 dígitos" required></label><br>
    <label>Capacidade (kg): <input type="number" id="capacidadeKg" step="0.01" min="0" required></label>
    <label>Capacidade (m³): <input type="number" id="capacidadeM3" step="0.0001" min="0" required></label><br>
    <button type="submit">Cadastrar Posição</button>
  </form>

  <table id="tabelaPosicoes">
    <thead>
      <tr>
        <th>Endereço</th>
        <th>Capacidade (kg)</th>
        <th>Capacidade (m³)</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr>

  <h2>Alocar Produto em Posição</h2>
  <div class="subtabs">
    <button type="button" class="active" data-subtab="selecionar" onclick="trocarSubAba('selecionar')">Selecionar</button>
    <button type="button" data-subtab="resumo" onclick="trocarSubAba('resumo')">Resumo</button>
  </div>
  <div id="sub-selecionar" class="subtab-content active">
  <form id="alocacaoForm">
    <label>SKU do Produto:
      <select id="skuAlocar"></select>
    </label>
    <label>Endereço:
      <select id="enderecoAlocar"></select>
    </label><br>
    <div>
      <label>DESC: <input type="text" id="descSelecionada" readonly></label>
      <label>UN: <input type="text" id="unidadeSelecionada" readonly></label>
      <label>Peso (kg): <input type="number" id="pesoSelecionado" readonly></label>
      <label>Volume (m³): <input type="number" id="volumeSelecionado" readonly></label>
    </div>
    <div>
      <label>Capacidade pos. (kg): <input type="number" id="capKgSelecionada" readonly></label>
      <label>Capacidade pos. (m³): <input type="number" id="capM3Selecionada" readonly></label>
    </div>
    <label>Quantidade: <input type="number" id="quantidadeAlocar" min="1" step="1" required></label>
    <span style="margin-left:10px;">Uso Peso:</span>
    <div class="progress"><span id="barPeso"></span></div>
    <span id="lblPeso" style="font-size:12px;color:#7f8c8d;margin-left:6px;"></span>
    <br>
    <span>Uso Volume:</span>
    <div class="progress"><span id="barVolume"></span></div>
    <span id="lblVolume" style="font-size:12px;color:#7f8c8d;margin-left:6px;"></span>
    <br>
    <button type="submit">Alocar Produto</button>
  </form>
  </div>

  <div id="sub-resumo" class="subtab-content">
    <table id="tabelaResumo">
      <thead>
        <tr>
          <th>Endereço</th>
          <th>Uso Peso</th>
          <th>Uso Volume</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <table id="tabelaAlocacoes">
    <thead>
      <tr>
        <th>Endereço</th>
        <th>SKU</th>
        <th>Descrição</th>
        <th>Quantidade</th>
        <th>Peso Total (kg)</th>
        <th>Volume Total (m³)</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr>
  <div class="toolbar">
    <button class="secondary" onclick="exportarJSON()">Exportar JSON</button>
    <label class="secondary" style="padding:8px 12px;background:#ecf0f1;border-radius:4px;cursor:pointer;">
      Importar JSON
      <input type="file" id="inputImport" accept="application/json" style="display:none;" />
    </label>
    <button class="danger" onclick="limparBase()">🧹 Limpar Toda a Base de Dados</button>
  </div>
  <div id="toast" class="toast"></div>
  </div>

  <script>
    const produtoForm = document.getElementById('produtoForm');
    const posicaoForm = document.getElementById('posicaoForm');
    const alocacaoForm = document.getElementById('alocacaoForm');
    const tabelaProdutos = document.getElementById('tabelaProdutos').querySelector('tbody');
    const tabelaPosicoes = document.getElementById('tabelaPosicoes').querySelector('tbody');
    const tabelaAlocacoes = document.getElementById('tabelaAlocacoes').querySelector('tbody');
    const skuAlocar = document.getElementById('skuAlocar');
    const enderecoAlocar = document.getElementById('enderecoAlocar');
    const descSelecionada = document.getElementById('descSelecionada');
    const unidadeSelecionada = document.getElementById('unidadeSelecionada');
    const pesoSelecionado = document.getElementById('pesoSelecionado');
    const volumeSelecionado = document.getElementById('volumeSelecionado');
    const capKgSelecionada = document.getElementById('capKgSelecionada');
    const capM3Selecionada = document.getElementById('capM3Selecionada');
    const filtroProdutos = document.getElementById('filtroProdutos');
    const filtroPosicoes = document.getElementById('filtroPosicoes');
    const barPeso = document.getElementById('barPeso');
    const barVolume = document.getElementById('barVolume');
    const lblPeso = document.getElementById('lblPeso');
    const lblVolume = document.getElementById('lblVolume');
    const kpiProdutos = document.getElementById('kpiProdutos');
    const kpiPosicoes = document.getElementById('kpiPosicoes');
    const kpiAlocacoes = document.getElementById('kpiAlocacoes');
    const inputImport = document.getElementById('inputImport');

    function carregarProdutos() {
      tabelaProdutos.innerHTML = '';
      skuAlocar.innerHTML = '';
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const termo = (filtroProdutos?.value || '').trim().toUpperCase();
      produtos
        .filter(p => !termo || p.sku.includes(termo) || (p.descricao||'').includes(termo))
        .forEach(produto => {
          const linha = tabelaProdutos.insertRow();
          linha.innerHTML = `
            <td>${produto.sku}</td>
            <td>${produto.descricao}</td>
            <td>${produto.unidade}</td>
            <td>${produto.peso}</td>
            <td>${produto.volume || 0}</td>
            <td><button class="danger" onclick="excluirProduto('${produto.sku}')">Excluir</button></td>
          `;
          const option = document.createElement('option');
          option.value = produto.sku;
          option.textContent = `${produto.sku} - ${produto.descricao}`;
          skuAlocar.appendChild(option);
        });
    }

    function carregarPosicoes() {
      tabelaPosicoes.innerHTML = '';
      enderecoAlocar.innerHTML = '';
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const termo = (filtroPosicoes?.value || '').trim().toUpperCase();
      posicoes
        .filter(p => !termo || (p.endereco||'').toUpperCase().includes(termo))
        .forEach(posicao => {
          const linha = tabelaPosicoes.insertRow();
          linha.innerHTML = `
            <td>${posicao.endereco}</td>
            <td>${posicao.capacidadeKg}</td>
            <td>${posicao.capacidadeM3}</td>
            <td><button class="danger" onclick="excluirPosicao('${posicao.endereco.replace(/'/g, "&#39;")}')">Excluir</button></td>
          `;
          const option = document.createElement('option');
          option.value = posicao.endereco;
          option.textContent = posicao.endereco;
          enderecoAlocar.appendChild(option);
        });
    }

    function carregarAlocacoes() {
      tabelaAlocacoes.innerHTML = '';
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      alocacoes.forEach(aloc => {
        const linha = tabelaAlocacoes.insertRow();
        linha.innerHTML = `
          <td>${aloc.endereco}</td>
          <td>${aloc.sku}</td>
          <td>${aloc.descricao}</td>
          <td>${aloc.quantidade}</td>
          <td>${aloc.pesoTotal}</td>
          <td>${aloc.volumeTotal || 0}</td>
          <td><button class=\"danger\" onclick=\"excluirAlocacao('${aloc.id || ''}')\">Excluir</button></td>
        `;
      });
    }

    produtoForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const skuVal = document.getElementById('sku').value.toUpperCase();
      const descVal = document.getElementById('descricao').value.toUpperCase();
      const unVal = document.getElementById('unidade').value.toUpperCase();
      const pesoVal = parseFloat(document.getElementById('peso').value);
      const volumeVal = parseFloat(document.getElementById('volume').value);

      const skuRegex = /^[A-Z0-9]{5}$/;
      if (!skuRegex.test(skuVal)) {
        alert('SKU inválido. Use 5 caracteres alfanuméricos.');
        return;
      }
      if (descVal.length === 0 || descVal.length > 50) {
        alert('Descrição deve ter até 50 caracteres.');
        return;
      }
      if (!(pesoVal >= 0) || !(volumeVal >= 0)) {
        alert('Peso e Volume devem ser números válidos (>= 0).');
        return;
      }

      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      if (produtos.some(p => p.sku === skuVal)) {
        alert('SKU já cadastrado.');
        return;
      }

      const produto = {
        sku: skuVal,
        descricao: descVal,
        unidade: unVal,
        peso: pesoVal,
        volume: volumeVal
      };

      produtos.push(produto);
      localStorage.setItem('produtos', JSON.stringify(produtos));
      produtoForm.reset();
      carregarProdutos();
    });

    posicaoForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const armazemVal = document.getElementById('armazem').value.toUpperCase();
      const ruaVal = document.getElementById('rua').value;
      const nivelVal = document.getElementById('nivel').value;
      const prateleiraVal = document.getElementById('prateleira').value;
      const capKgVal = parseFloat(document.getElementById('capacidadeKg').value);
      const capM3Val = parseFloat(document.getElementById('capacidadeM3').value);

      const armRegex = /^[A-Z][0-9]{2}$/;
      if (!armRegex.test(armazemVal)) {
        alert('Armazém inválido. Use 1 letra seguida de 2 dígitos (ex.: A12).');
        return;
      }
      if (!/^\d{2}$/.test(ruaVal) || !/^\d{2}$/.test(nivelVal) || !/^\d{3}$/.test(prateleiraVal)) {
        alert('Rua (2 dígitos), Nível (2 dígitos) e Prateleira (3 dígitos) são obrigatórios.');
        return;
      }
      if (!(capKgVal >= 0) || !(capM3Val >= 0)) {
        alert('Capacidades devem ser números válidos (>= 0).');
        return;
      }

      const endereco = `Armazém ${armazemVal} / Rua ${ruaVal.padStart(2, '0')} / Nível ${nivelVal.padStart(2, '0')} / Prateleira ${prateleiraVal.padStart(3, '0')}`;
      const posicao = {
        endereco: endereco,
        capacidadeKg: capKgVal,
        capacidadeM3: capM3Val
      };
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      posicoes.push(posicao);
      localStorage.setItem('posicoes', JSON.stringify(posicoes));
      posicaoForm.reset();
      carregarPosicoes();
    });

    alocacaoForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const sku = document.getElementById('skuAlocar').value;
      const endereco = document.getElementById('enderecoAlocar').value;
      const quantidade = parseInt(document.getElementById('quantidadeAlocar').value);
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');

      const produto = produtos.find(p => p.sku === sku);
      const posicao = posicoes.find(p => p.endereco === endereco);

      if (!produto || !posicao) {
        alert('Produto ou posição inválidos.');
        return;
      }
      if (!(quantidade > 0)) {
        alert('Quantidade deve ser um inteiro positivo.');
        return;
      }

      const pesoTotal = (produto.peso || 0) * quantidade;
      const volumeTotal = (produto.volume || 0) * quantidade;

      const pesoAtual = alocacoes
        .filter(a => a.endereco === endereco)
        .reduce((acc, a) => acc + a.pesoTotal, 0);
      const volumeAtual = alocacoes
        .filter(a => a.endereco === endereco)
        .reduce((acc, a) => acc + (a.volumeTotal || 0), 0);

      if (pesoAtual + pesoTotal > posicao.capacidadeKg) {
        alert("Erro: Capacidade de peso (kg) excedida na posição!");
        return;
      }
      if (volumeAtual + volumeTotal > posicao.capacidadeM3) {
        alert("Erro: Capacidade de volume (m³) excedida na posição!");
        return;
      }

      alocacoes.push({
        endereco: endereco,
        sku: sku,
        descricao: produto.descricao,
        quantidade: quantidade,
        pesoTotal: pesoTotal,
        volumeTotal: volumeTotal,
        id: `a_${Date.now()}_${Math.random().toString(36).slice(2,8)}`
      });

      localStorage.setItem('alocacoes', JSON.stringify(alocacoes));
      alocacaoForm.reset();
      carregarAlocacoes();
    });

    function atualizarProdutoSelecionado() {
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const sku = skuAlocar.value;
      const produto = produtos.find(p => p.sku === sku);
      if (produto) {
        descSelecionada.value = produto.descricao || '';
        unidadeSelecionada.value = produto.unidade || '';
        pesoSelecionado.value = produto.peso || 0;
        volumeSelecionado.value = produto.volume || 0;
      } else {
        descSelecionada.value = '';
        unidadeSelecionada.value = '';
        pesoSelecionado.value = '';
        volumeSelecionado.value = '';
      }
    }

    function atualizarPosicaoSelecionada() {
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const endereco = enderecoAlocar.value;
      const posicao = posicoes.find(p => p.endereco === endereco);
      if (posicao) {
        capKgSelecionada.value = posicao.capacidadeKg || 0;
        capM3Selecionada.value = posicao.capacidadeM3 || 0;
      } else {
        capKgSelecionada.value = '';
        capM3Selecionada.value = '';
      }
      atualizarPreviewCapacidade();
    }

    skuAlocar.addEventListener('change', () => { atualizarProdutoSelecionado(); atualizarPreviewCapacidade(); });
    enderecoAlocar.addEventListener('change', () => { atualizarPosicaoSelecionada(); atualizarPreviewCapacidade(); });
    document.getElementById('quantidadeAlocar').addEventListener('input', atualizarPreviewCapacidade);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) { atualizarResumoCapacidade(); atualizarKpis(); } });

    function atualizarPreviewCapacidade() {
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      const sku = skuAlocar.value;
      const endereco = enderecoAlocar.value;
      const quantidade = parseInt(document.getElementById('quantidadeAlocar').value || '0');
      const produto = produtos.find(p => p.sku === sku);
      const posicao = posicoes.find(p => p.endereco === endereco);
      if (!produto || !posicao) {
        if (barPeso) { barPeso.style.width = '0%'; barPeso.className = ''; }
        if (barVolume) { barVolume.style.width = '0%'; barVolume.className = ''; }
        if (lblPeso) lblPeso.textContent = '';
        if (lblVolume) lblVolume.textContent = '';
        return;
      }
      const pesoAtual = alocacoes.filter(a => a.endereco === endereco).reduce((acc, a) => acc + a.pesoTotal, 0);
      const volumeAtual = alocacoes.filter(a => a.endereco === endereco).reduce((acc, a) => acc + (a.volumeTotal || 0), 0);
      const pesoNovo = (produto.peso || 0) * (quantidade || 0);
      const volumeNovo = (produto.volume || 0) * (quantidade || 0);
      const pesoPct = Math.min(100, ((pesoAtual + pesoNovo) / (posicao.capacidadeKg || 1)) * 100);
      const volPct = Math.min(100, ((volumeAtual + volumeNovo) / (posicao.capacidadeM3 || 1)) * 100);
      const pesoCls = pesoPct < 70 ? 'ok' : pesoPct < 90 ? 'warn' : 'danger';
      const volCls = volPct < 70 ? 'ok' : volPct < 90 ? 'warn' : 'danger';
      if (barPeso) { barPeso.style.width = pesoPct + '%'; barPeso.className = pesoCls; }
      if (barVolume) { barVolume.style.width = volPct + '%'; barVolume.className = volCls; }
      if (lblPeso) lblPeso.textContent = `${(pesoAtual + pesoNovo).toFixed(2)} / ${posicao.capacidadeKg} kg`;
      if (lblVolume) lblVolume.textContent = `${(volumeAtual + volumeNovo).toFixed(4)} / ${posicao.capacidadeM3} m³`;
    }

    function showToast(msg, isError) {
      const t = document.getElementById('toast');
      if (!t) { if (isError) { alert(msg); } else { console.log(msg); } return; }
      t.textContent = msg;
      t.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => { t.className = 'toast'; }, 2200);
    }

    function trocarSubAba(qual) {
      document.querySelectorAll('.subtabs button').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.subtabs button[data-subtab="${qual}"]`);
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.subtab-content').forEach(sec => sec.classList.remove('active'));
      const alvo = document.getElementById(`sub-${qual}`);
      if (alvo) alvo.classList.add('active');
      if (qual === 'resumo') atualizarResumoCapacidade();
    }

    function atualizarResumoCapacidade() {
      const tbody = document.querySelector('#tabelaResumo tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      posicoes.forEach(p => {
        const pesoAtual = alocacoes.filter(a => a.endereco === p.endereco).reduce((acc, a) => acc + a.pesoTotal, 0);
        const volAtual = alocacoes.filter(a => a.endereco === p.endereco).reduce((acc, a) => acc + (a.volumeTotal || 0), 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.endereco}</td>
          <td>${pesoAtual.toFixed(2)} / ${p.capacidadeKg} kg</td>
          <td>${volAtual.toFixed(4)} / ${p.capacidadeM3} m³</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function atualizarKpis() {
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]');
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      if (kpiProdutos) kpiProdutos.textContent = produtos.length;
      if (kpiPosicoes) kpiPosicoes.textContent = posicoes.length;
      if (kpiAlocacoes) kpiAlocacoes.textContent = alocacoes.length;
    }

    function excluirProduto(sku) {
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      if (alocacoes.some(a => a.sku === sku)) { alert('Não é possível excluir: SKU alocado.'); return; }
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]').filter(p => p.sku !== sku);
      localStorage.setItem('produtos', JSON.stringify(produtos));
      carregarProdutos(); atualizarKpis(); showToast('Produto excluído');
    }

    function excluirPosicao(endereco) {
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      if (alocacoes.some(a => a.endereco === endereco)) { alert('Não é possível excluir: posição possui alocações.'); return; }
      const posicoes = JSON.parse(localStorage.getItem('posicoes') || '[]').filter(p => p.endereco !== endereco);
      localStorage.setItem('posicoes', JSON.stringify(posicoes));
      carregarPosicoes(); atualizarKpis(); showToast('Posição excluída');
    }

    function garantirIdsAlocacoes() {
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]');
      let mudou = false;
      alocacoes.forEach(a => { if (!a.id) { a.id = `a_${Date.now()}_${Math.random().toString(36).slice(2,8)}`; mudou = true; } });
      if (mudou) localStorage.setItem('alocacoes', JSON.stringify(alocacoes));
    }

    function excluirAlocacao(id) {
      if (!id) { showToast('Não foi possível identificar a alocação', true); return; }
      const alocacoes = JSON.parse(localStorage.getItem('alocacoes') || '[]').filter(a => a.id !== id);
      localStorage.setItem('alocacoes', JSON.stringify(alocacoes));
      carregarAlocacoes(); atualizarPreviewCapacidade(); atualizarKpis(); showToast('Alocação excluída');
    }

    function exportarJSON() {
      const dados = {
        produtos: JSON.parse(localStorage.getItem('produtos') || '[]'),
        posicoes: JSON.parse(localStorage.getItem('posicoes') || '[]'),
        alocacoes: JSON.parse(localStorage.getItem('alocacoes') || '[]')
      };
      const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'wms_data.json'; a.click(); URL.revokeObjectURL(url);
      showToast('JSON exportado');
    }

    function exportarProdutosCSV() {
      const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
      const linhas = [['SKU','DESCRICAO','UN','PESO_KG','VOLUME_M3']].concat(
        produtos.map(p => [p.sku, p.descricao, p.unidade, p.peso, p.volume])
      );
      const csv = linhas.map(l => l.map(v => '"' + String(v ?? '').replace(/"/g, '""') + '"').join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'produtos.csv'; a.click(); URL.revokeObjectURL(url);
      showToast('CSV exportado');
    }

    if (inputImport) {
      inputImport.addEventListener('change', (ev) => {
        const file = ev.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            if (!obj || typeof obj !== 'object') throw new Error('JSON inválido');
            if (!confirm('Isso substituirá os dados atuais. Continuar?')) return;
            localStorage.setItem('produtos', JSON.stringify(obj.produtos || []));
            localStorage.setItem('posicoes', JSON.stringify(obj.posicoes || []));
            localStorage.setItem('alocacoes', JSON.stringify(obj.alocacoes || []));
            carregarProdutos(); carregarPosicoes(); garantirIdsAlocacoes(); carregarAlocacoes(); atualizarKpis(); atualizarPreviewCapacidade();
            showToast('Importação concluída');
          } catch (e) {
            showToast('Falha ao importar JSON', true);
          }
        };
        reader.readAsText(file);
      });
    }

    function limparBase() {
      if (!confirm("Tem certeza que deseja apagar todos os dados?")) {
        return;
      }
      const senha = prompt('Digite a senha para confirmar (0124):');
      if (senha !== '0124') {
        alert('Senha incorreta. Operação cancelada.');
        return;
      }
      localStorage.removeItem('produtos');
      localStorage.removeItem('posicoes');
      localStorage.removeItem('alocacoes');
      carregarProdutos();
      carregarPosicoes();
      carregarAlocacoes();
      atualizarKpis();
      atualizarPreviewCapacidade();
      showToast('Base apagada com sucesso.');
    }

    carregarProdutos();
    carregarPosicoes();
    garantirIdsAlocacoes();
    carregarAlocacoes();
    atualizarKpis();
    // Inicializa
    atualizarProdutoSelecionado();
    atualizarPosicaoSelecionada();
    atualizarPreviewCapacidade();
    if (filtroProdutos) filtroProdutos.addEventListener('input', carregarProdutos);
    if (filtroPosicoes) filtroPosicoes.addEventListener('input', carregarPosicoes);
  </script>
</body>
</html>
